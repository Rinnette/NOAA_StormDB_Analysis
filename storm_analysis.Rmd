---
title: "Analysis of NOAA Storm data"
author: "Rinnette Ramdhanie"
date: "4 September 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Reading the data
The data was loaded directly from the zipped file and stored in a data table to be maniputlated using the *dplyr* package.

```{r loadData}
        library(dplyr)
        stormdata <- tbl_df(read.csv("repdata_data_StormData.csv.bz2", stringsAsFactors = FALSE))
```

## Processing the data
The documentation provided with the data describes 48 different event types. However, there are 985 uniques values in the EVTYPE variable.  

```{r}
        length(unique(stormdata$EVTYPE))
```

There were several variations of each event type due to incorrect spelling, variations of the same name etc.  

The FATALITIES and INJURIES columns are required to show how the various weather events affect population health.



### Replacing event names
The second list is more or less a subset of the first so, as a result, 39 events were renamed based on guidance from the documentation on how each event was measured as well as the examples on what each event may include.  Note that there are a couple of events in lower case.  These will be converted to upper case before editing.
Events replaced. A copy of the original data set was created for processing.

```{r}
        sd_edited <- stormdata
        
        # Ensure all values in the EVTYPE variable are in upper case
                sd_edited$EVTYPE <- toupper(sd_edited$EVTYPE)
        
        # Begin substitutions
                #consider using sd_edited[grep("whatever", ed_edited$EVTYPE)] <- "correct name"
                
                # fix sd_edited$EVTYPE <- gsub("COLD", "COLD/WIND CHILL", sd_edited$EVTYPE)
                sd_edited$EVTYPE <- gsub("LANDSLIDE", "DEBRIS FLOW", sd_edited$EVTYPE)
                sd_edited$EVTYPE <- gsub("HEAT WAVE|^EXTREME HEAT|^RECORD HEAT", "EXCESSIVE HEAT", sd_edited$EVTYPE)
                sd_edited$EVTYPE <- gsub("^EXTREME COLD", "EXTREME COLD/WIND CHILL", sd_edited$EVTYPE)
                sd_edited$EVTYPE <- gsub("ICY ROADS|BLACK ICE", "FROST/FREEZE", sd_edited$EVTYPE)
                sd_edited$EVTYPE <- gsub("EXCESSIVE RAINFALL", "HEAVY RAIN", sd_edited$EVTYPE)
                sd_edited$EVTYPE <- gsub("^HURRICANE", "HURRICANE/TYPHOON", sd_edited$EVTYPE)
                sd_edited$EVTYPE <- gsub("^TSTM WIND|THUNDERSTORM WINDS|THUNDERSTORMW", "THUNDERSTORM WIND", sd_edited$EVTYPE)
                # fix sd_edited$EVTYPE <- gsub("SNOW", "HEAVY SNOW", sd_edited$EVTYPE)
                sd_edited$EVTYPE <- gsub("RIP CURRENTS", "RIP CURRENT", sd_edited$EVTYPE)
                # fix sd_edited$EVTYPE <- gsub("HEAVY SURF/HIGH SURF", "HIGH SURF", sd_edited$EVTYPE)
                sd_edited$EVTYPE <- gsub("^HIGH WINDS|^WIND$|DRY MICROBLAST|^STRONG WINDS$", "HIGH WIND", sd_edited$EVTYPE)
                sd_edited$EVTYPE <- gsub("^ICE$|ICE STORM", "ICE STORM", sd_edited$EVTYPE)
                sd_edited$EVTYPE <- gsub("^STORM SURGE", "STORM TIDE", sd_edited$EVTYPE)
                sd_edited$EVTYPE <- gsub("WILD/FOREST FIRE|WILD FIRES", "WILDFIRES", sd_edited$EVTYPE)
                
                sd_edited$EVTYPE <- gsub("^BLIZZARD|BLIZZARD$", "BLIZZARD", sd_edited$EVTYPE)
                #HEAVY SNOW
                #SLEET
                #WINTRY MIX etc. from below
                sd_edited$EVTYPE <- gsub("WINTRY MIX|WINTER WEATHER/MIX|SNOW SQUALL|FREEZING RAIN", "WINTER WEATHER", sd_edited$EVTYPE)
                
                sd_edited$EVTYPE <- gsub("^FOG$|DENSE FOG", "DENSE FOG", sd_edited$EVTYPE)
                sd_edited$EVTYPE <- gsub("GLAZE", "FROST/FREEZE", sd_edited$EVTYPE)
                sd_edited$EVTYPE <- gsub("URBAN/SML STREAM FLD", "FLOOD", sd_edited$EVTYPE)
                sd_edited$EVTYPE <- gsub("TROPICAL STORM GORDON", "TROPICAL STORM", sd_edited$EVTYPE)
                sd_edited$EVTYPE <- gsub("WATERSPOUT/TORNADO", "WATERSPOUT", sd_edited$EVTYPE)
                
```

## Question 1: Across the United States, which types of events are most harmful with respect to population health?

The edited database, **sd_edited**, was used to create a plot showing the events harmful to the population.  The FATALITIES and INJURIES variables were used.

### Plot Injuries against event type

```{r}
        # Group by Event type, sum injuries for each event and arrange in descending order
                inj_ordered <- sd_edited %>%
                        group_by(EVTYPE) %>%
                        summarise (inj_sum = sum(INJURIES)) %>%
                        arrange(desc(inj_sum))
        
        # Take the top 10 events
                inj_plotdata <- head(inj_ordered, 10)
        
        # Make EVTYPE an ordered factor so that ggplot does not re-order it
                inj_plotdata$EVTYPE <- factor(inj_plotdata$EVTYPE, levels = inj_plotdata$EVTYPE)

        # Plot injuries
                library(ggplot2)
                injPlot <- ggplot(inj_plotdata, aes(EVTYPE, inj_sum)) +
                        geom_bar(stat = "identity", fill = "#a3b6d6") +
                        xlab("Type of Weather Event") +
                        theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
                        ylab("Number of Injuries") +
                        ggtitle("")
```

### Plot Fatalities against event type

```{r}
        # Group by Event type, sum fatalities for each event and arrange in descending order
                fat_ordered <- sd_edited %>%
                        group_by(EVTYPE) %>%
                        summarise (fat_sum = sum(FATALITIES)) %>%
                        arrange(desc(fat_sum))
        
        # Take the top 10 events
                fat_plotdata <- head(fat_ordered, 10)
        
        # Make EVTYPE an ordered factor so that ggplot does not re-order it
                fat_plotdata$EVTYPE <- factor(fat_plotdata$EVTYPE, levels = fat_plotdata$EVTYPE)

        # Plot fatalities
                fatPlot <- ggplot(fat_plotdata, aes(EVTYPE, fat_sum)) +
                        geom_bar(stat = "identity", fill = "#a3b6d6") +
                        scale_y_continuous(name = "No. of Fatalities", breaks=seq(0, 1e+5, 1e+4)) +
                        xlab("Type of Weather Event") +
                        theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
                        #ylab("Number of Fatalities") +
                        ggtitle("")
```

### Arrange both plots in one panel

```{r}
        library(gridExtra)
        grid.arrange(injPlot, fatPlot)

```


## Question 2: Across the United States, which types of events have the greatest economic consequences?

The following variables can be used to determine how each event affects the economy:
* PROPDMG - contains figure representing estimates of the damage done to property
* PROPDMGEXP - an alpha character that signifies the magnitude of the amount of the figure in PROPDMG, ie.
        + H - hundreds
        + K - thousands
        + M - millions
        + B - billions
* CROPDMG - contains figure representing estimates of the damage done to crops
* CROPDMGEXP - an alpha character that signifies the magnitude of the amount of the figure in CROPDMG.  The values are the same as for PROPDMGEXP.

The values of the PROPDMGEXP were checked for validity.

```{r}
       # table(sd_edited$PROPDMGEXP)
        #table(sd_edited$CROPDMGEXP)
        
        # to check what the property damage data looks like
                propdata <- sd_edited %>%
                        group_by(PROPDMGEXP) %>%
                        summarise (prop_sum = sum(PROPDMG)) %>%
                        arrange(desc(prop_sum))
```
Some of the PROPDMGEXP values seem invalid.  These include digits "0" to "8", "-", "?", "+". There is nothing in the documentation to indicate what these characters mean so unfortunately for the purposes of this exercise they have to be ignored.  

A similar exercise was done for the CROPDMGEXP variable.

```{r}
       # To check what the crop damage data looks like
                cropdata <- sd_edited %>%
                        group_by(CROPDMGEXP) %>%
                        summarise (crop_sum = sum(CROPDMG)) %>%
                        arrange(desc(crop_sum))
```

Similarly, as with PROPDMGEXP, the seemingly invalid characters will have to be ignored.


## Select data for plot
The columns and rows to be used for the analysis were selected.

```{r}
        # Select the appropriate columns
                econtmp <- select(sd_edited, EVTYPE, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP)

        # Filter required rows 
                prop <- filter(econtmp, PROPDMGEXP %in% c("B", "b", "M", "m", "K", "k"))
                crop <- filter(econtmp, CROPDMGEXP %in% c("B", "b", "M", "m", "K", "k"))
```

The characters "K", "M" and "B" ,in PROPDMGEXP and CROPDMGEXP, were replaced with the corresponding numeric values so that the dollar values of the damages can be calculated.

```{r}
        prop$PROPDMGEXP <- gsub("K", 1000, prop$PROPDMGEXP, ignore.case = TRUE)
        prop$PROPDMGEXP <- gsub("M", 1e+06, prop$PROPDMGEXP, ignore.case = TRUE)
        prop$PROPDMGEXP <- gsub("B", 1e+09, prop$PROPDMGEXP, ignore.case = TRUE)
        prop$PROPDMGEXP <- as.numeric(prop$PROPDMGEXP)
                
        crop$CROPDMGEXP <- gsub("K", 1000, crop$CROPDMGEXP, ignore.case = TRUE)
        crop$CROPDMGEXP <- gsub("M", 1e+06, crop$CROPDMGEXP, ignore.case = TRUE)
        crop$CROPDMGEXP <- gsub("B", 1e+09, crop$CROPDMGEXP, ignore.case = TRUE)
        crop$CROPDMGEXP <- as.numeric(crop$CROPDMGEXP)        

        # Calculate damages
        prop <- mutate(prop, propDamages = PROPDMG * PROPDMGEXP)
        crop <- mutate(crop, cropDamages = CROPDMG * CROPDMGEXP)
```

The data was then grouped by EVTYPE and ordered by the sum of the damages for each event type.

```{r}
        propOrdered <- prop %>%
                        group_by(EVTYPE) %>%
                        summarise (p_sum = sum(propDamages)) %>%
                        arrange(desc(p_sum))

        cropOrdered <- crop %>%
                        group_by(EVTYPE) %>%
                        summarise (c_sum = sum(cropDamages)) %>%
                        arrange(desc(c_sum))
```




